#!/bin/bash

export RUBYOPT='-W:no-deprecated -W:no-experimental'
export PRINT_LOG='true'
export ESM_ENV='development'
export RUST_LOG='info'
export TCP_SERVER_PORT='3003'

# Compile tcp_server
cargo update --package esm_message
cargo build --release

# Failed to build, don't start
if [ $? -ne 0 ]
then
  exit $?
fi

# Start the tcp_server
bin/tcp_server &

# Start the bot
if [[ -z $1 ]]
then
  rerun --dir lib bin/esm.rb
else
  bundle exec ruby bin/esm.rb
fi

kill -9 $(pgrep -f esm_server) > /dev/null 2>&1
